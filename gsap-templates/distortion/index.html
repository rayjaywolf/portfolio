<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Distortion Effect Demo</title>
    <!-- External CSS -->
    <link rel="stylesheet" href="style.css" />
    <!-- GSAP Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.0/color-thief.umd.js"></script>
    <!-- External JavaScript -->
    <script src="script.js" defer></script>
  </head>
  <body>
    <div class="container">
      <div class="image-container" style="filter: url(#svg-distortion-filter)">
        <div class="image-wrapper -active">
          <img src="1.jpg" alt="Image 1" />
        </div>
        <div class="image-wrapper">
          <img src="2.jpg" alt="Image 2" />
        </div>
        <div class="image-wrapper">
          <img src="3.jpg" alt="Image 3" />
        </div>
      </div>
      <div class="text-container">
        <div class="text-wrapper">
          <h1>Image 1</h1>
        </div>
        <div class="text-wrapper">
          <h1>Image 2</h1>
        </div>
        <div class="text-wrapper">
          <h1>Image 3</h1>
        </div>
      </div>
    </div>

    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 463 463"
      style="position: absolute; top: -1px; left: -1px; height: 0; width: 0"
      id="svg-distortion"
    >
      <defs>
        <filter id="svg-distortion-filter">
          <feTurbulence
            type="fractalNoise"
            baseFrequency="0.01 0.003"
            stitchTiles="noStitch"
            numOctaves="1"
            seed="2"
            result="warp"
          ></feTurbulence>
          <feDisplacementMap
            xChannelSelector="R"
            yChannelSelector="G"
            scale="1"
            in="SourceGraphic"
            in2="warp"
          ></feDisplacementMap>
        </filter>
      </defs>
    </svg>

    <script>
      const svgFilter = document.querySelector("#svg-distortion-filter");
      const svgFilterTurbulence = svgFilter.querySelector("feTurbulence");
      const svgFilterDisplacementMap =
        svgFilter.querySelector("feDisplacementMap");
      const figures = document.querySelector(".image-container");
      const figure = document.querySelectorAll(".image-wrapper");
      const navs = document.querySelector(".text-container");
      const nav = document.querySelectorAll(".text-wrapper");

      let lastActive = 0;

      const setActive = (index) => {
        if (lastActive === index) return;
        figure.forEach((el, i) => {
          el.classList.toggle("-active", index === i);
          nav[i].classList.toggle("-active", index === i);
        });

        changeBackgroundColor(index);

        makeDisplace();

        lastActive = index;
      };

      const makeDisplace = () => {
        const tl = gsap.timeline();
        gsap.killTweensOf(svgFilterDisplacementMap);
        tl.set(
          svgFilterTurbulence,
          {
            attr: { seed: gsap.utils.random(2, 150) },
          },
          0
        );
        tl.to(
          svgFilterDisplacementMap,
          {
            attr: { scale: gsap.utils.random(80, 120) },
            duration: 0.2,
          },
          0
        );
        tl.to(
          svgFilterDisplacementMap,
          {
            attr: { scale: 1 },
            duration: 1.2,
            ease: "expo.out",
          },
          0.2
        );
      };

      const changeBackgroundColor = (index) => {
        const colorThief = new ColorThief();
        const image = figure[index].querySelector("img");
        const dominantColor = colorThief.getColor(image);
        document.body.style.backgroundColor = `rgb(${dominantColor.join(",")})`;
      };

      nav.forEach((el, i) => {
        el.addEventListener("mouseenter", () => {
          setActive(i);
          console.log(i);
        });
      });

      document.addEventListener("click", () => {});
    </script>
  </body>
</html>
